#!/usr/bin/env sh

# Get list of files that differ from origin/main
CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1)

# Check if any Rust files in packages/core changed
RUST_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^packages/core/.*\.rs$" || true)

# Check if any TS/TSX files in packages/ui changed
TS_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^packages/ui/" || true)

echo "ğŸš€ Running pre-push checks..."

# Run Rust lint if core changed
if [ -n "$RUST_CHANGED" ]; then
  echo "ğŸ¦€ Rust files changed, running cargo clippy..."
  (cd packages/core && cargo clippy --all-targets --all-features -- -D warnings)
  if [ $? -ne 0 ]; then
    echo "âŒ Rust lint failed. Push aborted."
    exit 1
  fi
fi

# Run Biome lint if ui files changed
if [ -n "$TS_CHANGED" ]; then
  echo "ğŸ“¦ TypeScript files changed, running biome check..."
  bunx biome check packages/ui
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript lint failed. Push aborted."
    exit 1
  fi
fi

echo "âœ… All checks passed!"
